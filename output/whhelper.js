// ==UserScript==
// @name         WykopHelper
// @version      0.43
// @updateURL    http://plw.usermd.net/whhelper.js
// @downloadURL  http://plw.usermd.net/whhelper.js
// @description  Zestaw narzędzi pomocnych na wykopie.
// @author       PLW
// @match        https://www.wykop.pl/*
// @require      https://cdn.jsdelivr.net/npm/sweetalert2@9
// @require      https://unpkg.com/@popperjs/core@2
// @require      https://unpkg.com/tippy.js@6
// @grant        none
// ==/UserScript==
!function(){"use strict";const e=location.href,t=()=>e.indexOf("wykop.pl/link/")>-1||e.indexOf("wykop.pl/mikroblog/")>-1||e.indexOf("wykop.pl/wpis/")>-1||e.indexOf("wykop.pl/moj/")>-1||e.indexOf("wykop.pl/tag/")>-1,n=()=>!!(e.indexOf("wykop.pl/ustawienia/")>-1),a=()=>!!(e.indexOf("wykop.pl/ustawienia/wykophelper")>-1),o=()=>!!(e.indexOf("wykop.pl/link/")>-1),l=()=>!!(e.indexOf("wykop.pl/wpis/")>-1),r="trolls",i="uniqueNicks",s="whsettings",c={BADGE:{NICK_ELEMENTS:"li div.author",NICK_ELEMENT:"author",NICK:".showProfileSummary > b",BADGE:"badge",MARK_BUTTON:"buttonWH",MARK_BUTTON_CLICKED:"buttonWH--clicked",REPLY_FORM:".replyForm textarea",COMMENT_FORM:"#commentFormContainer textarea",DATASET:{USERNAME:e=>"[data-whusername='"+e},MODAL_BUTTON_REMOVE:"modalWH-button--remove",NICK_VERIFIED_BADGE:"verified"},SETTINGS:{LAST_NAV_ELEMENT:"#site .nav > ul > li:last-child",ACTIVE_NAV_ELEMENT:"#site .nav > ul .active",SETTINGS_FORM_ELEMENT:"#site .grid-main .settings",WH_NAV_SETTINGS_LINK:"whSettingsLink",WH_USER_TABLE:"tableWH",WH_USER_TABLE_CONTAINER:"tableWH__container",WH_USER_TABLE_BODY:"tableWH__body"},HIGHLIGHT_OP:{OP_THREAD:'[data-type="entry"]',HIGHLIGHT_BUTTON:"button--highlightOp",AUTHOR_COMMENTS:"authorComment"}},d=(e,t="debil")=>`<span class="badge badge--${t.toLowerCase()}" data-whusername="${e}">${t.toLowerCase().capitalize()}</span>`,p=e=>{const t=`<style> ${e} </style>`;document.body.insertAdjacentHTML("afterbegin",t)},{BADGE:u}=c,m=()=>{let e,t=[];const n=e=>!!t.includes(e),a=(a,o)=>{n(a)||((e=>{t.push(e),localStorage.setItem(i,JSON.stringify(t))})(a),((t,n)=>{e.push({nick:t,link:n}),localStorage.setItem(r,JSON.stringify(e))})(a,o))},o=()=>document.querySelectorAll(u.NICK_ELEMENTS),l=e=>e.querySelector(u.NICK).innerText,c=()=>location.reload(),m=e=>!e.querySelector("."+u.BADGE),y=()=>{const e=document.querySelector(u.REPLY_FORM),t=document.querySelector(u.COMMENT_FORM);return!(e&&""!==e.value||t&&""!==t.value)},g=()=>{e=localStorage.getItem(r)?JSON.parse(localStorage.getItem(r)):[],t=localStorage.getItem(i)?JSON.parse(localStorage.getItem(i)):[]},k=(e=(()=>JSON.parse(localStorage.getItem(s)).BADGE.DEFAULT_NAME)())=>{try{o().forEach(t=>{const a=l(t);n(a)&&m(t)?t.insertAdjacentHTML("afterbegin",d(a,e)):(e=>!!e.querySelector("."+u.MARK_BUTTON))(t)||t.insertAdjacentHTML("beforeend",'<span class="button buttonWH">Oznacz</span>')})}catch(e){}},w=e=>{g();const t=l(e.target.closest("."+u.NICK_ELEMENT)),r=e.target.closest("."+u.NICK_ELEMENT).querySelector(".verified")?e.target.closest("."+u.NICK_ELEMENT).querySelector(`.${u.NICK_VERIFIED_BADGE} + a`).href:e.target.closest("."+u.NICK_ELEMENT).querySelector("a + a").href;e.target.classList.add(u.MARK_BUTTON_CLICKED),e.target.innerText="✔",setTimeout(()=>{e.target.remove()},700),a(t,r),(()=>{try{o().forEach(e=>{const t=l(e);n(t)&&m(e)&&e.insertAdjacentHTML("afterbegin",d(t)),n(t)&&m(e)&&e.querySelector("."+u.MARK_BUTTON)&&!e.querySelector("."+u.MARK_BUTTON_CLICKED)&&e.querySelector("."+u.MARK_BUTTON).remove()})}catch(e){}})()},E=n=>{g();for(let[t,a]of e.entries())a.nick===n&&(delete e[t],e=e.filter(e=>null!=e),localStorage.setItem(r,JSON.stringify(e)));t=t.filter(e=>e!==n),localStorage.setItem(i,JSON.stringify(t)),y?c():Swal.fire({title:"Hej!",text:"Wygl&#x0105;da na to, &#x017c;e jeste&#x015b; w trakcie pisania komentarza. Kliknij &quot;Anuluj&quot;, &#x017c;eby doko&#x0144;czy&#x0107; pisanie i r&#x0119;cznie od&#x015b;wie&#x017c;y&#x0107; stron&#x0119; p&oacute;&#x017a;niej (to konieczne by znikn&#x0119;&#x0142;a odznaka przy nicku u&#x017c;ytkownika). Je&#x015b;li to pomy&#x0142;ka, i nie masz nic przeciw od&#x015b;wie&#x017c;eniu strony, naci&#x015b;nij &quot;OK&quot;.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Od&#x015b;wie&#x017c;",cancelButtonText:"Anuluj"}).then(e=>{e.value&&c()})},_=t=>{const n=(t=>{g();for(let n=0;n<e.length;n++){if(e[n].nick===t)return{link:e[n].link,nick:e[n].nick};void 0!==e[n]&&e[n]}})(document.querySelector(t).dataset.whusername);((e,t,n)=>{tippy(e,{content:t,allowHTML:!0,interactive:!0,placement:"bottom-start",followCursor:"initial",delay:n?[n,null]:0})})(t,((e,t)=>`\n  <p class="modalWH-text">Powód  oznaczenia: \n    <a href="${e}" target="_blank">link</a>\n  </p>\n  <span class="modalWH-button modalWH-button--remove" data-whuserremove="${t}">Usuń oznaczenie</span>\n`)(n.link,n.nick))};p("\n.button {\n  display: inline-block;\n  padding: .2rem .2rem;\n  border: 1px solid #9999996e;\n  cursor: pointer;\n  margin-left: .5rem;\n  color: #808080ba;\n  border-radius: .3rem;\n  font-size: .7rem;\n  line-height: .7rem;\n  transition: .3s all;\n}\n.buttonWH:hover {\n  border-color: green;\n}\n.buttonWH--clicked {\n  border-color: green;\n  opacity: 0;\n}\n.badge {\n  color: red;\n  font-weight: bold;\n  margin-right: .3rem;\n  border: 1px solid currentColor;\n  padding: .1rem .2rem;\n}\n.modalWH-button {\n  display: block;\n  padding: .4rem .8rem;\n  border: 1px solid #9999996e;\n  cursor: pointer;\n  color: #808080ba;\n  border-radius: .3rem;\n  font-size: 1rem;\n  line-height: 1rem;\n  transition: .3s all;\n}\n.author .modalWH-text {\n  position: relative;\n  margin-bottom: .5rem;\n  top: unset;\n  right: unset;\n  left: unset;\n  bottom: unset;\n}\n.tippy-box {\n  width: 20rem;\n}\n.tippy-content {\n  display: flex;\n  flex-direction: column;\n}\n\n.button--highlightOp {\n  position: absolute;\n  top: .1rem;\n  left: 0;\n}\n\n@media screen and (min-width: 722px) {\n  .button--highlightOp {\n    top: 6rem;\n    left: 1rem;\n  }\n}\n"),g(),k(),document.querySelector("."+u.BADGE)&&document.querySelectorAll("."+u.BADGE).forEach(e=>{const t=e.dataset.whusername;setTimeout(_(u.DATASET.USERNAME(t)),1150)}),document.getElementById("itemsStream").addEventListener("click",e=>{const t=e.target;if(t.classList.contains(u.MARK_BUTTON)&&w(e),t.classList.contains("affect")&&t.closest(".more")&&setTimeout(()=>{g(),k()},500),t.classList.contains(u.MODAL_BUTTON_REMOVE)){console.log(t);const e=t.dataset.whuserremove;E(e)}})};let y=["alternews.pl","alexjones.pl","dziennik-polityczny.com","koniec-swiata.org","magnapolonia.org","narodowcy.net","nczas.com","mysl.pl","ndie.pl","neon24.pl","newsweb.pl","parezja.pl","prostozmostu24.pl","prawdaobiektywna.pl","reporters.pl","sioe.pl","wmeritum.pl","wolnosc24.pl","wolna-polska.pl","wprawo.pl","wsensie.pl","zmianynaziemi.pl","sputniknews.com","rt.com","ruptly.tv","prawica.net","xportal.pl","kresy.pl","bdp.xportal.pl","geopolityka.org","pravda.ru","voiceofrussia.com","ria.ru","ligakobietpolskich.pl","ronik.org.pl","obserwatorpolityczny.pl","mysl-polska.plw"];y.forEach(e=>{y.push("https://"+e),y.push("https://www."+e),y.push("http://"+e),y.push("http://www."+e)});const g=y,k=()=>{(()=>{let e;return localStorage.getItem(s)&&(e=JSON.parse(localStorage.getItem(s))),!!e.GENERAL.WARN_ON_SUSPECTED_RUSSIAN_PROPAGANDA})()&&(()=>{const e=document.querySelector(".article h2 a").href,t=new URL(e),n=t.protocol+"//"+t.hostname,a=((e,t="alert")=>`\n  <div class="annotation type-${t} space clearfix">\n\t\t<p>${e}</p>\n\t</div>\n`)("Uważaj! Źródło tego znaleziska jest podejrzewane o szerzenie rosyjskiej propagandy.");g.includes(n)&&document.querySelector(".bspace").insertAdjacentHTML("beforebegin",a)})()},w={BADGE:{HIDE_MARKED_USERS:!1,DEFAULT_NAME:"Debil",DEFAULT_COLOR:"red"},GENERAL:{WARN_ON_RELOAD:!0,WARN_ON_SUSPECTED_RUSSIAN_PROPAGANDA:!0}},E=()=>{localStorage.getItem(s)||localStorage.setItem(s,JSON.stringify(w))},{SETTINGS:_}=c,b=()=>{let e,t,n;const a=document.querySelector(_.SETTINGS_FORM_ELEMENT),o=(...a)=>{[...a].length<1||[...a].includes("settings")?localStorage.getItem(s)?e=JSON.parse(localStorage.getItem(s)):E():[...a].includes("markedUsers")&&(t=localStorage.getItem(r)?JSON.parse(localStorage.getItem(r)):[],n=localStorage.getItem(i)?JSON.parse(localStorage.getItem(i)):[])},l=()=>{o(),document.querySelector(_.ACTIVE_NAV_ELEMENT).classList.remove("active"),document.querySelector("."+_.WH_NAV_SETTINGS_LINK).classList.add("active"),a.innerHTML="",a.innerHTML='\n<fieldset>\n  <h4>WykopHelper - Ustawienia</h4>\n\x3c!-- GENERAL --\x3e\n  <div class="space settings--general">\n    <div class="row">\n      <input\n        class="checkbox"\n        type="checkbox"\n        category="GENERAL"\n        name="WARN_ON_RELOAD"\n        id="warnOnReload"\n        checked\n        disabled\n      />\n      <label title="Ficzer jeszcze nieaktywny" class="settings__crossed inline" for="warnOnReload">Ostrzegaj przy próbie zamknięcia/przeładowania strony gdy wykryto pisanie komentarza</label>\n    </div>\n    <div class="row">\n      <input\n        class="checkbox"\n        type="checkbox"\n        category="GENERAL"\n        name="WARN_ON_SUSPECTED_RUSSIAN_PROPAGANDA"\n        id="warnOnRussian"\n        checked\n      />\n      <label class="inline" for="warnOnRussian">Oznaczaj znaleziska ze źródeł podejrzewanych o szerzenie Rosyjskiej propagandy [<a href="https://oko.press/rosyjska-propagande-szerza-polskie-portale-znalezlismy-23-takie-witryny/" target="_blank">Więcej -></a>]</label>\n    </div>\n  </div>\n\x3c!--  BADGE --\x3e\n  <div class="space settings--badge">\n    <div class="row">\n      <input\n        class="checkbox"\n        type="checkbox"\n        category="BADGE"\n        name="HIDE_MARKED_USERS"\n        id="hideMarkedUser"\n        disabled\n      />\n      <label title="Ficzer jeszcze nieaktywny" class="inline settings__crossed" for="hideMarkedUser">Ukrywaj treści oznakowanych użytkowników (tak jak na czarnej liście)</label>\n    </div>\n    <div class="row space">\n      <input placeholder="Domyślny tekst odznaki" id="badgeDefaultValue" category="BADGE" value="" name="DEFAULT_NAME" type="text">\n      <small>Domyślny tekst odznaki</small>\n    </div>\n  </div>\n\x3c!-- SPECIAL --\x3e\n  <div class="space settings--special">\n    <div class="row">\n      <small>Jeśli chcesz wyczyścić listę oznaczonych wcześniej użytkowników, możesz to zrobić poniżej. W związku z tym, że jest to akcja nieodwracalna, musisz najpierw potwierdzić, że na pewno taki jest Twój cel. Uwaga - po kliknięciu przycisku akcja wykonywana jest natychmiast, bez dodatkowych potwierdzeń!</small>\n    </div>\n    <div class="row">\n      <input\n        class="checkbox"\n        type="checkbox"\n        category="SPECIAL"\n        name="ALLOW_WIPE_MARKED_LIST"\n        id="allowWipeAllMarked"\n      />\n      <label class="inline" for="allowWipeAllMarked">Zaznacz by odblokować możliwość wyczyszczenia listy</label>\n    </div>\n    <div class="row space">\n      <button style="opacity:0.4" id="whsettings__remove-all-marked" disabled>Wyczyść</button>\n    </div>\n    <div class="row space">\n      <button class="button" id="showAllMarked">Pokaż wszystkich oznaczonych użytkowników</button>\n    </div>\n  </div>\n</fieldset>\n',a.removeAttribute("method"),a.removeAttribute("action"),a.insertAdjacentHTML("afterend",'\n<div class="tableWH__container tableWH__container--hidden">\n  <h4 class="tableWH__heading">WykopHelper - Lista oznaczonych użytkowników</h4>\n  <table class="tableWH">\n    <thead class="tableWH__head">\n      <tr>\n        <td>no.</td>\n        <td>Nick</td>\n        <td>Typ</td>\n        <td>Link</td>\n      </tr>\n    </thead>\n    <tbody class="tableWH__body">\n    </tbody>\n  </table> \n</div>\n'),(()=>{o("markedUsers");const e=document.querySelector("."+_.WH_USER_TABLE_BODY);for(let o=0;o<t.length;o++){const i=t[o];e.insertAdjacentHTML("beforeend",(n=o+1,a=i.nick,l=i.type||"Debil",r=i.link,`\n    <tr>\n      <td>${n}</td>\n      <td><a href="https://www.wykop.pl/ludzie/${a}" target="_blank">${a}</a></td>\n      <td>${l}</td>\n      <td><a href="${r}" target="_blank">&#128279</a></td>\n    </tr>\n    `))}var n,a,l,r})(),document.getElementById("badgeDefaultValue").value=e.BADGE.DEFAULT_NAME,document.getElementById("warnOnRussian").checked=e.GENERAL.WARN_ON_SUSPECTED_RUSSIAN_PROPAGANDA},c=()=>{a.addEventListener("change",t=>{const n=t.target.getAttribute("category"),a=t.target.name;"checkbox"===t.target.type&&"allowWipeAllMarked"!==t.target.id&&(e[n][a]=!e[n][a],localStorage.setItem(s,JSON.stringify(e)))}),a.addEventListener("click",e=>{"showAllMarked"===e.target.id&&(e.preventDefault(),document.querySelector("."+_.WH_USER_TABLE_CONTAINER).classList.toggle(_.WH_USER_TABLE_CONTAINER+"--hidden"),document.querySelector(`.${_.WH_USER_TABLE_CONTAINER}--hidden`)?document.getElementById("showAllMarked").textContent="Pokaż wszystkich oznaczonych użytkowników":document.getElementById("showAllMarked").textContent="Schowaj tabelę"),"allowWipeAllMarked"===e.target.id&&(e.target.disabled=!0,document.getElementById("whsettings__remove-all-marked").disabled=!1,document.getElementById("whsettings__remove-all-marked").style.opacity=1),"whsettings__remove-all-marked"===e.target.id&&(e.preventDefault(),n=[],t=[],localStorage.setItem(i,JSON.stringify(n)),localStorage.setItem(r,JSON.stringify(t)))}),a.addEventListener("keyup",t=>{const n=t.target.getAttribute("category"),a=t.target.name;"text"===t.target.type&&(e[n][a]=t.target.value.toLowerCase(),localStorage.setItem(s,JSON.stringify(e)))})};p("\n.tableWH__container {\n  padding: 1rem;\n}\n.tableWH__container--hidden {\n  display: none;\n}\n.tableWH__head {\n  font-weight: bold;\n  border-bottom: 2px solid currentColor;\n}\n.settings__crossed {\n  opacity: .4;\n  text-decoration: line-through;\n  cursor: not-allowed;\n}"),l(),o(),c()};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},localStorage.getItem("WHupdate")&&localStorage.getItem("WHupdate")<.42?(Swal.fire({title:"WykopHelper zaktualizowany!",html:'\nDodatek WykopHelper został właśnie zaktualizowany. Wprowadzone zmiany to: <br>\n<ul style="margin-top:1rem; list-style-type:square">\n  <li style="text-align:left;margin-left:2rem;margin-bottom:.7rem">\n    Czytając wpisy na mikroblogu, w pełnym widoku pojedynczego wątku, pod awatarem twócy wątku znajduje się teraz dodatkowy przycisk "Pokaż OPa". Po kliknięciu nań, komentarze twórcy wpisu zostaną pokolorowane na niebiesko (tryb nocny) lub pomarańczowo (dzienny). Pomoże to łatwo znaleźć wypowiedzi OPa w dłuuugich wątkach.\n  </li>\n  <li style="text-align:left;margin-left:2rem;margin-bottom:.7rem">\n    \n  </li>\n</ul>\n',icon:"info",confirmButtonText:"Okej!"}),localStorage.setItem("WHupdate",.42),(()=>{let e;e=localStorage.getItem("trolls")?JSON.parse(localStorage.getItem("trolls")):[],e.forEach(e=>{e.label||(e.label="")}),localStorage.setItem("trolls",JSON.stringify(e))})()):localStorage.getItem("WHupdate")||(Swal.fire({title:"WykopHelper zainstalowany!",html:'Miłego używania dodatku! Jeśli masz jakiekolwiek problemy, pytania lub sugestie, zgłoś je <a href="https://github.com/PLWpl/wykopoweTrole/issues" target="_blank">tutaj.</a>',icon:"success",confirmButtonText:"Super!"}),localStorage.setItem("WHupdate",.42)),E(),t()&&m(),n()&&document.querySelector(_.LAST_NAV_ELEMENT).insertAdjacentHTML("beforeend",'<li class="whSettingsLink"><a href="https://www.wykop.pl/ustawienia/wykophelper/"><span><strong>WykopHelper</strong> &#10024;</span></a></li>'),a()&&b(),o()&&k(),l()&&(document.querySelector(`${c.HIGHLIGHT_OP.OP_THREAD} .${c.BADGE.NICK_ELEMENT}`).insertAdjacentHTML("afterbegin",'<span class="button button--highlightOp">Pokaż OPa</span>'),document.querySelector("."+c.HIGHLIGHT_OP.HIGHLIGHT_BUTTON).addEventListener("click",()=>{const e=document.querySelector(".night")?"rgb(7, 68, 91)":"#ffeac1";document.querySelectorAll("."+c.HIGHLIGHT_OP.AUTHOR_COMMENTS).forEach(t=>{t.style.backgroundColor=e}),document.querySelector("."+c.HIGHLIGHT_OP.HIGHLIGHT_BUTTON).remove()}))}();
